# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Essential Commands

### Build and Development
```bash
# Build the project (uses cargo-px wrapper)
cargo px build
# or shorthand
cargo px b

# Run the development server (starts on port 8000)
cargo px run
# or shorthand
cargo px r

# Run all tests
cargo px test  
# or shorthand
cargo px t

# Run a specific test
cargo px test test_name

# Run tests for a specific crate
cargo px test -p app
```

### Code Quality
```bash
# Format code
cargo fmt

# Check formatting without applying
cargo fmt --check

# Lint with clippy
cargo clippy

# Generate code coverage
cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
cargo llvm-cov report --html --output-dir coverage
```

### Pavex-Specific Commands
```bash
# Verify the server_sdk is up-to-date
cargo px verify-freshness

# Regenerate server SDK (done automatically by cargo-px)
cargo px build
```

### Workspace Dependencies (Optional)
```bash
# Update workspace_hack for faster builds
cargo hakari generate && cargo hakari manage-deps -y
```

## Project Architecture

### High-Level Structure
This is a **personal blog platform** built with the [Pavex](https://pavex.dev) web framework. The project is a Rust workspace with these key crates:
- `app/` - Core application logic, models, routes
- `server/` - Server binary entry point
- `server_sdk/` - Auto-generated SDK from Pavex blueprint (do not edit manually)
- `shuttle/` - Shuttle deployment configuration
- `workspace_hack/` - Build optimization utility

### Key Framework Concepts
- **Pavex Blueprint System**: Route definitions and middleware are declared in `app/src/blueprint.rs`
- **Code Generation**: The `server_sdk` crate is automatically regenerated when the blueprint changes
- **cargo-px**: Must be used instead of regular `cargo` to ensure proper SDK regeneration

### Application Architecture
```
app/src/
â”œâ”€â”€ authorization/     # Authentication guards and current user extraction
â”œâ”€â”€ models/           # Domain models (currently: user management)
â”œâ”€â”€ routes/           # HTTP route handlers
â”‚   â”œâ”€â”€ auth/         # Registration, login, logout
â”‚   â”œâ”€â”€ admin/        # Protected admin dashboard
â”‚   â””â”€â”€ static_server.rs
â”œâ”€â”€ blueprint.rs      # Pavex blueprint definition
â””â”€â”€ configuration.rs  # App configuration management
```

### Database & Session Management
- **PostgreSQL** database with SQLx for queries
- **Session-based authentication** using `pavex_session` with PostgreSQL backend
- **Argon2** password hashing
- Database migrations handled through SQLx

### Current Development Status
Based on `project/plan.md`, the project is in **Phase 1** development:
- âœ… User registration system complete
- âœ… Database schema and test infrastructure
- âœ… Template system and static file serving
- ðŸ”„ Currently implementing authentication/login system
- ðŸ“‹ Next: Admin dashboard and blog post management

## Configuration System

### Environment Profiles
The app uses profile-based configuration via `PX_PROFILE` environment variable:
- `dev` (default) - Development mode, uses `configuration/dev.yml`
- `prod` - Production mode, uses `configuration/prod.yml`

### Configuration Files
- `configuration/base.yml` - Base configuration for all profiles
- `configuration/dev.yml` - Development-specific overrides
- `.cargo/config.toml` - Sets `PX_PROFILE=dev` by default
- `.env` (optional) - Local environment variables (ignored by git)

### Development Database Setup
Default dev configuration expects:
- PostgreSQL running on localhost:5432
- Database: `rusty_word_smith_org`
- Username/password: `postgres/password`

## Important Development Notes

### Critical Requirements
- **Always use `cargo px`** instead of `cargo` - this ensures the server SDK is regenerated when needed
- **Never manually edit `server_sdk/`** - it's auto-generated by Pavex
- The project uses Rust edition 2024

### Template and Static Files
- Templates stored in `templates/` directory
- Static files served from `static/` at `/static` endpoint
- Template rendering via Tera template engine

### Testing Strategy
- Unit tests included in model modules (e.g., `app/src/models/user/tests.rs`)
- Integration tests for route handlers
- Comprehensive test coverage expected for new features

### Session Management
- Sessions stored in PostgreSQL
- Cookie-based session tracking
- Session middleware automatically applied via blueprint

### Deployment
- Docker support with multi-stage build
- Shuttle deployment configuration available
- Production profile uses different database and security settings
